<?php
$month = $_GET['m'];
$vehicle = $_GET['v'];
$priority = $_GET['p'];
$center = $_GET['c'];
$transferRiver = $_GET['tr'];
$transferSea = $_GET['ts'];
$modeList = $_GET['ml'];
$excludeList = $_GET['el'];
$direction = $_GET['d'];

// display errors or not...

include 'conn.php';
$link = pg_connect($connectString_ov2);

$priorityQuery = "(o_speed_new(''".$vehicle."'',type,the_geom,cost) + o_alt_adjust(''".$vehicle."'',restricted))";
$priorityQuery4 = "(o_speed_new(''".$vehicle."'',type,o_routing.the_geom,".$transferSea."))";
$priorityQuery5 = "(o_speed_new(''".$vehicle."'',type,o_routing.the_geom,".$transferRiver."))";

if($priority == 1) {
$priorityQuery = "(o_expense(''".$vehicle."'',type,the_geom,cost))";
$priorityQuery4 = "(o_expense(''".$vehicle."'',type,o_routing.the_geom,".$transferSea."))";
$priorityQuery5 = "(o_expense(''".$vehicle."'',type,o_routing.the_geom,".$transferRiver."))";
}

else if($priority == 2) {
$priorityQuery = "((st_length(Geography(ST_Transform(the_geom,4326)))) / 1000)";
$priorityQuery4 = "0";
$priorityQuery5 = "0";
}

   $directedEdge = "source::integer,
    target::integer,";
if ($direction == 1) {
   $directedEdge = "target::integer as source,
    source::integer as target,";
}
$sql = "
WITH fin AS (
WITH gg AS (
WITH bb AS(
WITH rr AS (
SELECT

the_way

FROM

KDijkstra_ways_sp
     ('
SELECT DISTINCT ON (source,target)
gid as id,"
.$directedEdge.
"(CASE
when type = ''selfloop'' then 1
when type = ''transferc'' then ".$priorityQuery4."
when type = ''transferr'' then ".$priorityQuery5."
else ".$priorityQuery."
END) as cost
FROM
o_routing WHERE month IN(0,".$month.")
AND
(''".$modeList."'' LIKE (''%''||type||''%''))
AND (restricted NOT LIKE ''%''||type||''%'' OR restricted IS NULL)
AND
(
right(target::character varying,5)::integer NOT IN (".$excludeList.")
)
AND
(
right(source::character varying,5)::integer NOT IN (".$excludeList.")
)
OR
source = target
ORDER BY
source,
target,
".$priorityQuery."
',".$center.", '{
50247,50800,50445,50713,50794,50261,50151,50719,50689,50704,50179,50123,50496,50428,50404,50150,50403,50534,50578,50122,50253,50742,50594,50592,50369,50289,50112,50608,50102,50641,50225,50395,50309,50419,50187,50553,50541,50677,50683,50228,50022,50343,50081,50799,50035,50262,50536,50209,50176,50580,50214,50219,50052,50317,50155,50237,50773,50156,50351,50031,50619,50505,50023,50096,50734,50398,50697,50691,50631,50053,50125,50517,50264,50007,50460,50229,50405,50483,50104,50801,50611,50648,50296,50126,50647,50132,50627,50364,50725,50567,50321,50348,50278,50767,50073,50111,50779,50434,50761,50735,50394,50246,50220,50459,50249,50113,50337,50064,50528,50530,50160,50357,50668,50055,50212,50068,50548,50282,50181,50221,50183,50470,50593,50574,50748,50620,50563,50347,50163,50406,50335,50048,50361,50041,50231,50422,50280,50731,50478,50015,50609,50655,50575,50376,50554,50281,50078,50203,50667,50441,50776,50349,50749,50650,50437,50449,50501,50758,50178,50565,50182,50750,50673,50604,50008,50316,50646,50685,50208,50091,50393,50044,50475,50552,50702,50275,50025,50165,50148,50279,50757,50002,50518,50076,50265,50640,50189,50184,50772,50319,50017,50721,50474,50643,50292,50396,50088,50679,50777,50586,50157,50639,50145,50340,50109,50442,50789,50090,50310,50355,50568,50290,50288,50674,50542,50254,50263,50532,50432,50652,50260,50049,50344,50094,50239,50696,50473,50513,50531,50043,50266,50780,50153,50791,50345,50672,50617,50139,50512,50283,50233,50659,50135,50042,50430,50765,50730,50745,50564,50202,50669,50584,50533,50207,50255,50676,50170,50054,50103,50718,50218,50733,50603,50595,50798,50417,50444,50011,50277,50141,50782,50557,50797,50240,50186,50634,50786,50651,50018,50301,50539,50161,50468,50657,50230,50774,50274,50556,50465,50616,50633,50367,50315,50378,50510,50524,50693,50057,50033,50359,50699,50276,50069,50488,50766,50569,50714,50778,50180,50036,50062,50605,50271,50046,50105,50464,50080,50142,50433,50591,50010,50272,50756,50389,50515,50698,50358,50570,50059,50164,50087,50722,50760,50726,50166,50174,50093,50732,50599,50050,50193,50074,50572,50551,50391,50061,50724,50110,50172,50481,50004,50453,50635,50660,50695,50227,50775,50338,50037,50499,50416,50118,50525,50579,50374,50306,50223,50311,50014,50354,50029,50664,50248,50495,50173,50245,50550,50287,50523,50636,50415,50690,50149,50360,50072,50204,50682,50671,50325,50353,50375,50466,50379,50020,50066,50213,50128,50503,50561,50540,50362,50106,50115,50715,50519,50663,50144,50479,50543,50241,50746,50566,50423,50642,50079,50328,50095,50687,50457,50624,50175,50024,50751,50257,50485,50190,50547,50387,50097,50597,50596,50497,50558,50302,50741,50443,50793,50573,50424,50116,50291,50270,50333,50555,50127,50382,50336,50410,50199,50438,50084,50339,50269,50577,50323,50407,50787,50154,50107,50100,50618,50661,50313,50026,50143,50200,50755,50482,50600,50194,50082,50440,50720,50342,50377,50019,50380,50484,50467,50492,50368,50147,50736,50630,50622,50420,50469,50707,50356,50063,50298,50471,50446,50005,50065,50242,50486,50477,50740,50381,50117,50675,50508,50529,50654,50727,50628,50692,50077,50629,50352,50259,50205,50489,50612,50331,50318,50167,50217,50086,50244,50363,50684,50012,50215,50401,50152,50771,50056,50038,50785,50439,50621,50626,50294,50411,50436,50790,50400,50285,50195,50601,50067,50649,50678,50146,50293,50136,50535,50413,50738,50330,50185,50615,50458,50384,50320,50191,50666,50461,50759,50456,50737,50159,50665,50743,50447,50030,50051,50092,50500,50303,50537,50763,50451,50060,50133,50101,50177,50762,50001,50370,50327,50402,50131,50138,50454,50788,50308,50587,50250,50452,50472,50414,50544,50365,50234,50324,50334,50614,50670,50256,50490,50498,50222,50322,50754,50637,50307,50602,50211,50243,50120,50700,50784,50770,50006,50426,50703,50373,50425,50408,50450,50686,50516,50124,50549,50299,50538,50058,50644,50705,50350,50607,50268,50399,50039,50546,50171,50694,50099,50235,50032,50098,50462,50169,50764,50083,50034,50545,50491,50295,50158,50662,50527,50623,50427,50045,50716,50314,50366,50312,50409,50712,50383,50300,50560,50089,50562,50119,50130,50003,50781,50027,50390,50455,50739,50463,50016,50206,50392,50386,50709,50267,50795,50431,50192,50448,50509,50412,50571,50232,50581,50009,50188,50418,50520,50435,50226,50013,50613,50753,50582,50502,50210,50224,50632,50238,50706,50701,50114,50385,50168,50121,50598,50421,50576,50429,50252,50796,50070,50040,50717,50606,50201,50021,50708,50251,50371,50522,50506,50658,50329,50304,50783,50236,50216,50284,50507,50493,50273,50688,50341,50129,50297,50752,50332,50388,50710,50590,50610,50521,50588,50653,50768,50487,50559,50747,50526,50075,50137,50625,50585,50028,50680,50197,50108,50134,50047,50744,50372,50140,50769,50326,50286,50504,50681,50346,50792,50196,50162,50198,50711,50638,50085,50476,50258,50305,51170,51171,51172,51173,51175,51176,51177,51316,51324,51373,51375,51376,51384,51386,51392,51393,51399,51402,51403,51405,51444,51453,51455,51468,51469,51470,51480,51481,51485,51487,51503,51507,51509,51512,51514,51518,51522,51527,51531,51532,51537,51547,51554,51565,51567,51573,51577,51586,51587,51589,51596,51601,51608,51610,51611,51617,51619,51620,51624,51628,51629,51634,51635,51638,51639,51648,51649,51651,51659,51667,51669,51670,51671,51675,51678,51679,51685,51686,51687,51688,51690,51693,51699,51704,51705,51708,51715,51719,51721,51729,51733,51735,51739,51740,51742,51748,51749,51753,51755,51756,51757,51758,51760,51763,51764,51766,51767,51773,51783,51785,51788,51789,51791,51792,51795,51799,51801,51802,51807,51810,51811,51815,51817,51818,51821,51825,51829,51830,51836,51837,51838,51839,51853,51855,51857,51859,51861,51862,51865,51875,51877,51882,51883,51887,51893,51895,51897,51903,51904,51909,51910,51911,51913,51915,51917,51919,51920,51925,51926,51927,51931,51933,51936,51937,51939,51940,51941,51942,52209,52210,52211,52212,52225,52229
}',true,false)
)
SELECT replace(unnest(string_to_array(string_agg(the_way, ','),',')), ' ','') as i FROM rr
)
SELECT i, COUNT(i) as freq FROM bb WHERE i <> '' AND i <> 'NOTFOUND' GROUP by i ORDER BY i)
SELECT right(source::text, 5)::integer as source, right(target::text, 5)::integer as target, SUM(freq) as freq FROM gg, o_routing
WHERE i::integer = o_routing.gid
GROUP BY
right(source::text, 5)::integer, right(target::text, 5)::integer
)
SELECT
'\"source\",\"target\",\"freq\"
'||string_agg(source||','||target||','||freq||'
','')||''
FROM
fin
";

if (!$link) {
    echo "error, didn't make the pg_connect()";
} else {
	$result = pg_query($link, $sql);
	if (!$result) {
	  echo "error, no result!<br>";
      print pg_last_error($link);
	  exit;
	}
}

	while ($row = pg_fetch_row($result)) {
	  	echo($row[0]);

	}

pg_close($link);
?>
